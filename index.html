<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Galleria del Vento VR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
      // ─── Componente particelle vento custom (puro Three.js, no dipendenze) ───
      AFRAME.registerComponent('wind-particles', {
        schema: {
          count:  { type: 'int',    default: 8000 },
          color:  { type: 'color',  default: '#00ffff' },
          speed:  { type: 'number', default: 6 },
          spread: { type: 'number', default: 3 },
          length: { type: 'number', default: 12 },
          size:   { type: 'number', default: 0.015 }
        },

        init: function () {
          const d = this.data;
          const positions = new Float32Array(d.count * 3);
          this._velocities = new Float32Array(d.count);

          for (let i = 0; i < d.count; i++) {
            positions[i * 3]     = (Math.random() - 0.5) * d.spread * 2;
            positions[i * 3 + 1] = (Math.random() - 0.5) * d.spread;
            positions[i * 3 + 2] = (Math.random() - 0.5) * d.length;
            this._velocities[i]  = 0.5 + Math.random() * 1.5;
          }

          const geometry = new THREE.BufferGeometry();
          geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

          const material = new THREE.PointsMaterial({
            color: new THREE.Color(d.color),
            size: d.size,
            transparent: true,
            opacity: 0.55,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
            sizeAttenuation: true
          });

          this._points = new THREE.Points(geometry, material);
          this.el.object3D.add(this._points);
          this._halfLen = d.length / 2;
        },

        tick: function (time, delta) {
          if (!delta) return;
          const dt  = delta / 1000;
          const d   = this.data;
          const pos = this._points.geometry.attributes.position;

          for (let i = 0; i < d.count; i++) {
            pos.array[i * 3 + 2] -= this._velocities[i] * d.speed * dt;
            if (pos.array[i * 3 + 2] < -this._halfLen) {
              pos.array[i * 3]     = (Math.random() - 0.5) * d.spread * 2;
              pos.array[i * 3 + 1] = (Math.random() - 0.5) * d.spread;
              pos.array[i * 3 + 2] = this._halfLen;
            }
          }
          pos.needsUpdate = true;
        },

        remove: function () {
          this.el.object3D.remove(this._points);
        }
      });

      // ─── Componente linee di flusso (streamlines) ───────────────────────────
      AFRAME.registerComponent('flow-lines', {
        schema: {
          count:  { type: 'int',    default: 80 },
          length: { type: 'number', default: 14 },
          spread: { type: 'number', default: 2.5 },
          color:  { type: 'color',  default: '#004466' },
          speed:  { type: 'number', default: 5 }
        },

        init: function () {
          const d = this.data;
          this._lines = [];

          for (let i = 0; i < d.count; i++) {
            const x = (Math.random() - 0.5) * d.spread * 2;
            const y = (Math.random() - 0.5) * d.spread;
            const z = (Math.random() - 0.5) * d.length;

            const points = [
              new THREE.Vector3(x, y, z),
              new THREE.Vector3(x, y, z - d.length * 0.06)
            ];
            const geo = new THREE.BufferGeometry().setFromPoints(points);
            const mat = new THREE.LineBasicMaterial({
              color: new THREE.Color(d.color),
              transparent: true,
              opacity: 0.2,
              blending: THREE.AdditiveBlending,
              depthWrite: false
            });
            const line = new THREE.Line(geo, mat);
            line.userData.x = x;
            line.userData.y = y;
            line.userData.z = z;
            line.userData.v = 0.5 + Math.random() * 1.5;
            this.el.object3D.add(line);
            this._lines.push(line);
          }
          this._halfLen = d.length / 2;
        },

        tick: function (time, delta) {
          if (!delta) return;
          const dt = delta / 1000;
          const d  = this.data;

          for (const line of this._lines) {
            const ud = line.userData;
            ud.z -= ud.v * d.speed * dt;
            if (ud.z < -this._halfLen) {
              ud.z = this._halfLen;
              ud.x = (Math.random() - 0.5) * d.spread * 2;
              ud.y = (Math.random() - 0.5) * d.spread;
            }
            const pos = line.geometry.attributes.position;
            pos.setXYZ(0, ud.x, ud.y, ud.z);
            pos.setXYZ(1, ud.x, ud.y, ud.z - d.length * 0.06);
            pos.needsUpdate = true;
          }
        }
      });
    </script>
  </head>

  <body>
    <a-scene
      background="color: #020a0f"
      vr-mode-ui="enabled: true"
      renderer="antialias: true; colorManagement: true"
    >

      <!-- Asset -->
      <a-assets>
        <a-asset-item id="auto" src="macchina_test.glb"></a-asset-item>
      </a-assets>

      <!-- ─── Luci ─────────────────────────────────────────────── -->
      <a-light type="ambient"     color="#0a1a2a" intensity="0.6"></a-light>
      <a-light type="directional" position="2 4 1" color="#ffffff" intensity="0.5"></a-light>
      <a-light type="point" position="-3 0 -4" color="#00ffff" intensity="3" distance="6"></a-light>
      <a-light type="point" position=" 3 0 -4" color="#00aaff" intensity="3" distance="6"></a-light>
      <a-light type="point" position=" 0 2 -4" color="#0033ff" intensity="1.5" distance="5"></a-light>
      <a-light type="point" position="0 -0.3 -4" color="#004488" intensity="1" distance="4"></a-light>

      <!-- ─── Modello macchina ──────────────────────────────────── -->
      <a-entity position="0 0.4 -4">
        <a-entity
          gltf-model="#auto"
          rotation="0 0 0"
          scale="0.05 0.05 0.05"
        ></a-entity>
      </a-entity>

      <!-- ─── Particelle vento (layer principale, cyan) ─────────── -->
      <a-entity
        position="0 0.8 -4"
        wind-particles="count: 8000; color: #00eeff; speed: 7; spread: 3; length: 14; size: 0.012"
      ></a-entity>

      <!-- ─── Particelle vento (layer secondario, bianco lento) ─── -->
      <a-entity
        position="0 0.8 -4"
        wind-particles="count: 2000; color: #ffffff; speed: 3.5; spread: 2.5; length: 14; size: 0.025"
      ></a-entity>

      <!-- ─── Linee di flusso ───────────────────────────────────── -->
      <a-entity
        position="0 0.8 -4"
        flow-lines="count: 120; length: 14; spread: 3; color: #00aacc; speed: 6"
      ></a-entity>

      <!-- ─── Tunnel ───────────────────────────────────────────── -->
      <!-- Pavimento -->
      <a-plane
        position="0 -0.35 -4"
        rotation="-90 0 0"
        width="8" height="16"
        color="#001a2a"
        material="metalness: 0.9; roughness: 0.15"
      ></a-plane>
      <!-- Pareti -->
      <a-plane position="-3.5 1.5 -4" rotation="0  90 0" width="16" height="4" color="#001015" material="opacity: 0.7; transparent: true"></a-plane>
      <a-plane position=" 3.5 1.5 -4" rotation="0 -90 0" width="16" height="4" color="#001015" material="opacity: 0.7; transparent: true"></a-plane>
      <!-- Soffitto -->
      <a-plane position="0 3.5 -4" rotation="90 0 0" width="8" height="16" color="#000d14" material="opacity: 0.8; transparent: true"></a-plane>
      <!-- Griglia wireframe pavimento -->
      <a-entity position="0 -0.34 -4" rotation="-90 0 0">
        <a-entity
          geometry="primitive: plane; width: 8; height: 16"
          material="color: #00ffff; wireframe: true; opacity: 0.06; transparent: true"
        ></a-entity>
      </a-entity>

      <!-- ─── Strisce LED a parete ──────────────────────────────── -->
      <a-box position="-3.4 0.5 -4" width="0.04" height="0.04" depth="14" color="#00ffff" material="emissive: #00ffff; emissiveIntensity: 1; opacity: 0.4; transparent: true"></a-box>
      <a-box position=" 3.4 0.5 -4" width="0.04" height="0.04" depth="14" color="#00ffff" material="emissive: #00ffff; emissiveIntensity: 1; opacity: 0.4; transparent: true"></a-box>
      <a-box position="-3.4 2.5 -4" width="0.04" height="0.04" depth="14" color="#0044ff" material="emissive: #0044ff; emissiveIntensity: 1; opacity: 0.3; transparent: true"></a-box>
      <a-box position=" 3.4 2.5 -4" width="0.04" height="0.04" depth="14" color="#0044ff" material="emissive: #0044ff; emissiveIntensity: 1; opacity: 0.3; transparent: true"></a-box>

      <!-- ─── Camera VR ─────────────────────────────────────────── -->
      <a-entity
        camera
        look-controls="pointerLockEnabled: false"
        position="0 1.6 0"
      ></a-entity>

    </a-scene>
  </body>
</html>
